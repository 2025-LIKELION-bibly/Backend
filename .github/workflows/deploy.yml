name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle (skip tests for faster deployment)
        run: ./gradlew build -x test --no-daemon
        env:
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Get JAR file name
        id: jar
        run: |
          JAR_FILE=$(ls build/libs/*.jar | grep -v plain.jar)
          echo "file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/bibly-key.pem
          chmod 600 ~/.ssh/bibly-key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Stop application
        run: |
          ssh -i ~/.ssh/bibly-key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            sudo systemctl stop bibly.service || true
          '
        continue-on-error: true

      - name: Deploy JAR to EC2
        run: |
          scp -i ~/.ssh/bibly-key.pem ${{ steps.jar.outputs.file }} \
            ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/opt/bibly/bibly.jar

      - name: Update systemd service file
        run: |
          ssh -i ~/.ssh/bibly-key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            sudo tee /etc/systemd/system/bibly.service > /dev/null << EOF
          [Unit]
          Description=Bibly Spring Boot Application
          After=network.target

          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/opt/bibly
          ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod /opt/bibly/bibly.jar
          Restart=on-failure
          RestartSec=10
          StandardOutput=append:/var/log/bibly/application.log
          StandardError=append:/var/log/bibly/error.log

          Environment="DB_URL=${{ secrets.DB_URL }}"
          Environment="DB_USERNAME=${{ secrets.DB_USERNAME }}"
          Environment="DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
          Environment="SPRING_JPA_HIBERNATE_DDL_AUTO=update"

          [Install]
          WantedBy=multi-user.target
          EOF
          '

      - name: Start application
        run: |
          ssh -i ~/.ssh/bibly-key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            sudo systemctl daemon-reload
            sudo systemctl enable bibly.service
            sudo systemctl start bibly.service
          '

      - name: Wait for application to start
        run: sleep 45

      - name: Health check
        run: |
          ssh -i ~/.ssh/bibly-key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "Checking application health..."
            for i in {1..5}; do
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "✓ Application is healthy!"
                curl http://localhost:8080/actuator/health
                exit 0
              fi
              echo "Waiting for application... (attempt $i/5)"
              sleep 15
            done
            echo "✗ Application health check failed after 5 attempts"
            echo ""
            echo "Service Status:"
            sudo systemctl status bibly.service --no-pager -l
            echo ""
            echo "Recent Logs:"
            sudo journalctl -u bibly.service -n 50 --no-pager
            echo ""
            echo "Application Log:"
            sudo tail -50 /var/log/bibly/application.log
            exit 1
          '

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/bibly-key.pem

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "Application URL: http://${{ secrets.EC2_HOST }}:8080"
            echo "Swagger UI: http://${{ secrets.EC2_HOST }}:8080/swagger-ui.html"
          else
            echo "❌ Deployment failed."
          fi
